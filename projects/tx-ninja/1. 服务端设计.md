# 服务端设计

## 数据来源

当前的API频率限制上限为`50:1800`(次:秒)，即1小时100次，一天2400次。

以24赛季一个月以后的数据为例：

- 赛季32000+
- 独狼7000+
- 专家6000+

光赛季角色，单爬虫需要10多天才能爬完，双爬虫需要7天才能爬完。

>目前我最多只能同时维护2个爬虫。

### 使用poexport作为数据来源

poexport可以提供一些数据，但是存在一些问题：

- 数据难以校验，无法排除恶意提交的数据
- 数据难以保持稳定，比如一天一更新

但有总比没好。针对数据校验问题，用户必须认证后才能上传，用户只能上传自己的角色数据。

## 账户体系

应用需要提供一套账户体系，从而实现：

- 用户上传自己的角色数据以满足其快速更新自己排行榜的需求
- 用户可以锁定自己的角色
- ...

为了避免用户恶意上传数据，因此需要认证用户为真正的游戏用户，以及拥有目标角色的权限。

### 认证方式1：基于市集的认证

这是我最开始设想的认证方案，一种类似验证码的方式。用户注册时提供论坛账户名称、密码，验证方式是服务端返回随机价格和物品，要求用户以该价格上架目标物品，服务端查询市集验证存在有效期内上架的特定物品，价格匹配，论坛账户名称匹配。

>这是基于游戏的认证方式，还比如，可以使用一个挂机机器人，游戏内通过密语实现发送验证码等。

这种方式不需要用户提供额外的信息，但是存在以下缺点：

- 过程繁琐，需要游戏在线
- 受限于游戏，市集存在访问频率限制，挂机机器人需要硬件资源

### 认证方式2：基于poeSessId的认证

poeSessId是poe网站的token，可以通过`https://poe.game.qq.com/api/profile`查询基础的账户信息。

这种方式存在以下优点：

- 不需要用户提供密码，用户可以直接登录
- profile api目前不存在访问频率限制

这种方式也存在一些缺点：

- tx是否会检测poeSessId异地登陆的情况
- tx是否会检测同一ip大量登录同一poeSessId
- 用户存在抵触心理

目前，我决定使用第二种认证方式。